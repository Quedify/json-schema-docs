<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
</head>
<body>
<link href='https://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<style>
body {
    font-family: 'Inconsolata', sans-serif;
    font-size: 16px;
}
ul {
    width: 300px;
    margin: 20px;
}
.nav > li.nav-header > a {
    cursor: default;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
}
thead th {
    color: #FFF;
    background-color: #01213A;
}
code {
    color: #FFF;
    background-color: #042A48;
}
th {
    background-color: #91A0AC;
}
td {
    background-color: #C3C6C8;
}
</style>

<div ng-app="app">
    <div class="container-fluid" ng-cloak ng-controller="controller">
        <div class="row">
            <div class="col-sm-3 col-md-2 sidebar-offcanvas">
                <div class="list-group">
                    <span ng-repeat="item in sidebarItems">
                        <p class="list-group-item disabled">{{item.name}}</p>
                        <a class="list-group-item" ng-repeat="subResource in item.subResources" href="#{{subResource.id}}">{{subResource.name}}</a>
                    </span>
                </div>
            </div>
            <div class="col-sm-9 col-md-10">
                <div class="row" ng-repeat="resource in resources track by $index">
                    <div class="col-xs-12">
                        <h2>{{resource.resource}}</h2>
                        <h4 ng-if="resource.description">{{resource.description}}</h4>
                        <div ng-repeat="item in resource" ng-if="item.properties">
                            <hr>

                            <h4 id="{{item.id}}">{{item.name}}</h4>
                            <p>{{item.method}} <code>{{item.id}}</code></p>

                            <span ng-include src="'table.tpl'"></span>
                        </div>
                        <hr>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/ng-template" id="table.tpl">
        <table ng-if="item.type === 'object'" class="table table-bordered" style="margin-bottom:10px;">
            <thead>
                <tr>
                    <th>Field</th>
                    <th>Type</th>
                    <th>Meta</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tr ng-repeat="(prop, spec) in item.properties">
                <th>{{prop}} <span ng-if="spec.required" class="small">(required)</span></td>
                <td>{{spec.type}}</td>
                <td><span ng-include src="'meta.tpl'"></span></td>
                <td>{{spec.description}}</td>
            </tr>
        </table>
        <span ng-if="item.type !== 'object'">
            <table class="table table-bordered" style="margin-bottom:10px;">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Meta</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tr>
                    <td>{{item.type}}</td>
                    <td ng-bind-html="formatSpecMeta(item)"></td>
                    <td>{{item.description}}</td>
                </tr>
            </table>
        </span>
    </script>

    <script type="text/ng-template" id="meta.tpl">
        <span ng-if="spec.type === 'array'">
            <p><span ng-repeat="(key, val) in spec" ng-if="formatSpecMeta(val)" ng-bind-html="formatSpecMeta(val)"></span> </p>
            <p>Allowed Formats</p>
            <span ng-repeat="item in spec.items" ng-include src="'table.tpl'"></span>
        </span>
        <span ng-if="spec.type === 'object'" ng-include src="'table.tpl'"></span>
        <span ng-if="spec.type !== 'array' && spec.type !== 'object'" ng-bind-html="formatSpecMeta(spec)"></span>
    </script>
</div>
<br>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.3/angular.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.3/angular-sanitize.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.9.0/lodash.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/1.3.1/ui-bootstrap.js"></script>
<script src="/node_modules/json-ptr/releases/json-ptr-0.3.1.min.js"></script>
<script type="text/javascript">
angular.module('app', ['ui.bootstrap', 'ngSanitize']).config(function($httpProvider){
    $httpProvider.defaults.headers.common["X-Requested-With"] = 'XMLHttpRequest';
}).controller('controller', function($scope, $http, $timeout){

    $http.get('/schema').then(function(res){
        $scope.schema = mapJSON(res.data)
    })

    function mapJSON(schema) {
        replaceRefs(schema)

        $scope.resources = []
        buildFlatResourcesList(schema)
        $scope.sidebarItems = buildSidebar($scope.resources)
        _.map($scope.resources, function (resource) {
            mapRequiredOntoProperties(resource)
        })
        console.log($scope.resources)
    }

    function replaceRefs (schema) {
        /* This crawls the JSON schema for all $refs, and replaces them with the schema they're referencing */
        /* Maybe I'm misunderstanding JSON pointers. I was hoping I there was some magic JSON ptr api fn that replaces all $refs with the obj they reference */
        var ptr = JsonPointer.noConflict()
        _.forEach(_.keys(ptr.flatten(schema)), function (item) {
             var pathList = ptr.decode(item)
             if (pathList[pathList.length-1] === '$ref') {
                var objPath = '#/' + _.slice(pathList, 0, pathList.length-1).join('/') // building abs path to item with a $ref
                ptr.set(schema, objPath, ptr.get(schema, ptr.get(schema, item))) // set that item to the schema referenced in it's $ref
             }
        })
    }

    function buildFlatResourcesList (schema) {
        _.forEach(_.keys(schema), function (key) {
            var item = schema[key]
            if (_.isObject(item)) {
                _.forEach(_.keys(item), function (k) {
                    if (k === 'resource') {
                        buildFlatResourcesList(item)
                        item = _.omit(item, k)
                    }
                })
            }
            if (key === 'resource') {
                $scope.resources.push(schema)
            }
        })
    }

    function buildSidebar (resources) {
        return _.map(resources, function (item) {
            return {
                name: item.resource,
                subResources: _.chain(item).keys().map(function (key) {
                    /* mapping the name of the resource and the uri. name for the title in sidebar, id (uri) is used for bookmarking the item */
                    return {
                        name: item[key].name,
                        id: item[key].id
                    }
                }).filter('name').value()
            }
        })
    }

    function mapRequiredOntoProperties (resource) {
        var properties = _.get(resource, 'properties')
        var requiredProperties = _.get(resource, 'required')
        if (properties && requiredProperties) {
            _.forEach(requiredProperties, function (propertyName) {
                var property = _.get(properties, propertyName)
                if (!property) {
                    console.log(
                        "Property {prop} is listed as required in resource {resource}, but is not in the schema"
                        .replace('{prop}', propertyName).replace('{resource}', _.get(resource, 'name'))
                    )
                } else {
                    _.merge(property, { required: true })
                }
            })
        }
        /* if there is an object, recurse onto it */
        _.forEach(_.keys(resource), function (key) {
            /* if it's an object, go deeper */
            if (_.isObject(resource[key])) {
                mapRequiredOntoProperties(resource[key])
            }
            if (key === 'items' && _.isArray(resource[key])) {
                /* items can have an array of objects, so tree recursion here :) */
                _.forEach(resource[key], function (item) {
                    mapRequiredOntoProperties(resource[key])
                })
            }
        })
    }

    $scope.formatSpecMeta = function (spec) {
        if (!_.isObject(spec) || _.isArray(spec)) {
            return
        }

        var omittedSpecs = _.omit(spec, ['type', 'description', '$$hashKey', 'required', 'items'])
        if (!_.keys(omittedSpecs).length) {
            return
        }

        return _.map(_.keys(omittedSpecs), function (key) {
            return '<strong>'+key+':</strong> '+omittedSpecs[key]
        }).join(', ')
    }
});
</script>
</body>
</html>
